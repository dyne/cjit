#!/usr/bin/env zsh
#
# extract external symbols from library files on linux

lib=$1
[ -r "$lib" ] || {
	>&2 echo "Lib not found: $lib"
	exit 1
}

syms=`nm -WUg ${lib} | awk '$2 ~ T {if($3)print $3}' | grep -v '^_' | grep -v '.0$'`
name=`basename $lib | sed 's/\./_/g' | sed 's/-/_/g' | sed 's/_a$//g'`
cat <<EOF > src/${name}.c
// Generated by cjit/build/export-symbols.sh
// `date`

#include <libtcc.h>
// TODO: fill in needed includes here

void tcc_add_${name}_symbols(TCCState *TCC) {
EOF
for sym in ${(f)syms}; do
	# >&2 echo "+ ($name) $sym"
	echo "tcc_add_symbol(TCC, \"${sym}\", &${sym});" >> src/${name}.c
done
echo "}" >> src/${name}.c

>&2 echo "Generated symbol declaration: src/${name}.c"
