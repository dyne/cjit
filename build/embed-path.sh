#!/usr/bin/env bash

set -e

path="$1"
parent=`dirname ${1}`
name=${2:-`basename ${1}`}
pathname=`basename ${1}`
dst=src/embed_${name}.c

[ -r src/embedded.h ] || {
	>&2 echo "Build must generate src/embedded.h first"
	exit 1
}

[ -r src/embedded.c ] || {
	>&2 echo "Build must generate src/embedded.c first"
	exit 1
}

command -v xxd > /dev/null || {
  >&2 echo "Error not found: xxd binary not installed"
  exit 1
}

# >&2 echo "parent: $parent"
# >&2 echo "name: $name"
# >&2 echo "pathname: $pathname"
# >&2 echo "dest: $dst"

rm -f ${name}.tar.gz
prevpwd=`pwd`
cd ${parent}
[ "$pathname" != "$name" ] && cp -ra "$pathname" "$name"
tar --format ustar -cvzf ${prevpwd}/${name}.tar.gz "$name"
[ "$pathname" != "$name" ] && rm -rf "$name"
cd -

echo "// Embedded: $path" > $dst
echo "// source generated by cjit/build/embed-path.sh" >> $dst
echo "// `date`" >> $dst
echo "// ${name}" >> $dst
mv ${name}.tar.gz ${name}
xxd -i ${name} >> $dst
rm -f ${name}
# must be constant variables in stack
# sed inplace is not portable
if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i'' -e 's/unsigned char/const char/' $dst
    sed -i'' -e 's/unsigned int/const unsigned int/' $dst
else
    sed -i -e 's/unsigned char/const char/' $dst
    sed -i -e 's/unsigned int/const unsigned int/' $dst
fi

# xxd already converts dots in underscores
varname=`echo $name | sed 's/\./_/g'`

# generate embeddings in source for extract_embeddings(char *tmpdir)
echo "extern char *${varname};" >> src/embedded.h
echo "extern unsigned int ${varname}_len;" >> src/embedded.h

cat <<EOF >> src/embedded.c
snprintf(incpath,511,"%s/%s",CJIT->tmpdir,"${name}");
if(fresh) {
res = muntargz_to_path(CJIT->tmpdir,(char*)&${varname},${varname}_len);
}
if(res!=0) { // muntar returns 0 on success
_err("Error extracting %s",incpath);
return(false);
}
tcc_add_include_path(CJIT->TCC, incpath);
EOF
exit 0
